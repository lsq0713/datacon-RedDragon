# 测试记录

1. 第一次测试

   ``` python
    # 第一次测试(11.14) - 48.51
    # IP相同，用户数超过50，且属地不在北京/河北
    ip_dup_rid = unique_dup_filter(data, 'IP_ADDRESS', '患者ID', 50)
    ip_dup_rows = data[data['ID'].isin(ip_dup_rid)]
    ip_dup_rows = ip_dup_rows.sort_values(by='患者ID', ascending=True)
    area_limit_rows = ip_dup_rows[(ip_dup_rows['省份'] != '北京') & (ip_dup_rows['省份'] != '河北')]
    select1 = area_limit_rows['ID'].tolist()
    # 用户相同，在超过6个科室挂号
    select2 = unique_dup_filter(data, '患者ID', '就诊科室名称', 6)
    select = select1 + select2
    select = list(set(select))
    select.sort()
    write_list(select)
   ```

2. 第二次测试

   ``` py
   # 第二次测试(11.14) - 52.76
   # IP相同，用户数超过50，且属地不在北京/河北
   ip_dup_rows = unique_dup_filter(data, 'IP_ADDRESS', '患者ID', 50, get_row=True)
   area_limit_rows = ip_dup_rows[(ip_dup_rows['省份'] != '北京') & (ip_dup_rows['省份'] != '河北')]
   select1 = area_limit_rows['ID'].tolist()
   # 用户相同，在超过6个科室挂号
   select2 = unique_dup_filter(data, '患者ID', '就诊科室名称', 6)
   # 在5:00:00-5:00:01之间挂号
   select3 = daily_filter(data, '5:00:00', '5:00:01')['ID'].tolist()
   # 在16:00:00-16:00:01之间挂号(挂号第二天/下一周当天)
   select4 = hurry_sixteen(data)
   # 低频地区(少于10次操作)
   select5 = duplicate_detect(data, '省份', 10, False)['ID'].tolist()
   # 同一用户使用超过3个APPID操作
   select6 = unique_dup_filter(data, '患者ID', 'APPID', 3)
   select = select1 + select2 + select3 + select4 + select5 + select6
   select = list(set(select))
   select.sort()
   write_list(select)
   ```

3. 第三次测试

   ``` py
   # 第三次测试(11.15) - 35.89
   IP_USER = 50
   USER_DORM = 7
   AREA_COUNT = 20
   USER_APPID = 3
   DROP_LIMIT = 7
   # IP相同，用户数超过IP_USER，且属地不在北京/河北
   ip_dup_rows = unique_dup_filter(data, 'IP_ADDRESS', '患者ID', IP_USER, get_row=True)
   area_limit_rows = ip_dup_rows[(ip_dup_rows['省份'] != '北京') & (ip_dup_rows['省份'] != '河北')]
   select1 = area_limit_rows['ID'].tolist()
   # 用户相同，在超过USER_DORM个科室挂号
   select2 = unique_dup_filter(data, '患者ID', '就诊科室名称', USER_DORM)
   # 在5:00:00-5:00:01之间挂号
   select3 = daily_filter(data, '5:00:00', '5:00:01')['ID'].tolist()
   # 在16:00:00-16:00:01之间挂号(挂号第二天/下一周当天)
   select4 = hurry_sixteen(data)
   # 低频地区(少于AREA_COUNT次操作)
   select5 = duplicate_detect(data, '省份', AREA_COUNT, False)['ID'].tolist()
   # 同一用户使用超过USER_APPID个APPID操作
   select6 = unique_dup_filter(data, '患者ID', 'APPID', USER_APPID)
   # 同一用户超过DROP_LIMIT次退号
   select7 = frequent_drop(data, DROP_LIMIT)['ID'].tolist()

   selects = [select1, select2, select3, select4, select5, select6, select7]
   weights = [0.7, 0.5, 0.8, 0.3, 0.8, 0.6, 0.7]
   # 总得分超过LIMIT,且在前N个
   LIMIT = 0.5
   N = 6500
   res = weighted_selection(selects, weights, N, limit=LIMIT)
   res = [pair[0] for pair in res]
   res.sort()
   write_list(res)
   ```

4. 第四次测试

   ``` py
   # 第四次测试(11.15) - 54.07
   IP_USER = 50
   USER_DORM = 6
   AREA_COUNT = 40
   USER_APPID = 3
   DROP_LIMIT = 8
   # IP相同，用户数超过IP_USER，且属地不在北京/河北
   ip_dup_rows = unique_dup_filter(data, 'IP_ADDRESS', '患者ID', IP_USER, get_row=True)
   area_limit_rows = ip_dup_rows[(ip_dup_rows['省份'] != '北京') & (ip_dup_rows['省份'] != '河北')]
   select1 = area_limit_rows['ID'].tolist()
   # 用户相同，在超过USER_DORM个科室挂号
   select2 = unique_dup_filter(data, '患者ID', '就诊科室名称', USER_DORM)
   # 在5:00:00-5:00:01之间挂号
   select3 = daily_filter(data, '5:00:00', '5:00:01')['ID'].tolist()
   # 在16:00:00-16:00:01之间挂号(挂号第二天/下一周当天)
   select4 = hurry_sixteen(data)
   # 低频地区(少于AREA_COUNT次操作)
   area_limit = duplicate_detect(data, '省份', AREA_COUNT, False)
   select5 = area_limit['ID'].tolist()
   # 同一用户使用超过USER_APPID个APPID操作
   select6 = unique_dup_filter(data, '患者ID', 'APPID', USER_APPID)
   # 同一用户超过DROP_LIMIT次退号
   select7 = frequent_drop(data, DROP_LIMIT)['ID'].tolist()
   select = select1 + select2 + select3 + select4 + select5 + select6 + select7
   select = list(set(select))
   select.sort()
   write_list(select)
   ```

5. 第五次测试

   ``` py
   # 第五次尝试(11.15)
   # 异常值
   ## 7天内挂退号数量超过4的
   data['日期'] = data['就诊日期'].dt.date  # 提取日期
   count_within_7_days = data.groupby(['患者ID', '日期']).size().reset_index(name='次数')
   count_within_7_days['窗口'] = count_within_7_days['日期'].apply(lambda x: pd.date_range(start=x, periods=7))
   abnormal_1 = count_within_7_days[count_within_7_days['次数'] > 4]
   pids = abnormal_1['患者ID'].tolist()
   ## 同一天内退号三次的
   cancel_counts = data[data['状态'] == '已退号'].groupby(['患者ID', '日期']).size().reset_index(name='退号次数')
   abnormal_2 = cancel_counts[cancel_counts['退号次数'] > 3]
   pids += abnormal_2['患者ID'].tolist()
   abnormal = data[data['患者ID'].isin(pids)]

   IP_USER = 50
   USER_DORM = 7
   AREA_COUNT = 40
   USER_APPID = 3
   DROP_LIMIT = 8
   # IP相同，用户数超过IP_USER，且属地不在北京/河北
   ip_dup_rows = unique_dup_filter(data, 'IP_ADDRESS', '患者ID', IP_USER, get_row=True)
   area_limit_rows = ip_dup_rows[(ip_dup_rows['省份'] != '北京') & (ip_dup_rows['省份'] != '河北')]
   select1 = area_limit_rows['ID'].tolist()
   # 用户相同，在超过USER_DORM个科室挂号
   select2 = unique_dup_filter(data, '患者ID', '就诊科室名称', USER_DORM)
   # 在5:00:00-5:00:01之间挂号
   select3 = daily_filter(data, '5:00:00', '5:00:01')['ID'].tolist()
   # 在16:00:00-16:00:01之间挂号(挂号第二天/下一周当天)
   select4 = hurry_sixteen(data)
   # 同一用户使用超过USER_APPID个APPID操作
   select6 = unique_dup_filter(data, '患者ID', 'APPID', USER_APPID)
   # 同一用户超过DROP_LIMIT次退号
   select7 = frequent_drop(data, DROP_LIMIT)['ID'].tolist()

   selects = []
   selects.append(select1)
   selects.append(select2)
   selects.append(select3)
   selects.append(select4)
   selects.append(select6)
   selects.append(select7)

   # 上述规则中至少满足2条的
   sames = []
   for i in range(0, len(selects)):
      for j in range(0, i):
         _, _, same = lis_cmp(selects[i], selects[j], True)
         sames += same

   # 低频地区(少于AREA_COUNT次操作)
   area_limit = duplicate_detect(data, '省份', AREA_COUNT, False)
   select5 = area_limit['ID'].tolist()
   
   # 两条规则 + 不满足约束 + 低频地区
   res = sames + abnormal['ID'].tolist() + select5
   res = list(set(res))
   res.sort()
   write_list(res)
   ```
